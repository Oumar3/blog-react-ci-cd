name: Test React App

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed

jobs:
  test:
    # S'ex√©cute uniquement si le CI s'est termin√© (succ√®s OU √©chec)
    if: ${{ github.event.workflow_run.conclusion != 'cancelled' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'
          cache-dependency-path: blog/package-lock.json

      - name: Install dependencies
        run: |
          cd blog
          npm ci

      # V√©rifier que le CI a bien cr√©√© un artefact
      - name: Check CI status and artifacts
        run: |
          echo "üîç Workflow CI info:"
          echo "Run ID: ${{ github.event.workflow_run.id }}"
          echo "Run Number: ${{ github.event.workflow_run.run_number }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Status: ${{ github.event.workflow_run.status }}"
          echo "Head SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "üì¶ Artefact attendu: react-build-${{ github.event.workflow_run.run_number }}"
          
          # Si le CI a √©chou√©, on le signale
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
            echo "‚ö†Ô∏è ATTENTION: Le workflow CI n'a pas r√©ussi (${{ github.event.workflow_run.conclusion }})"
            echo "Le fallback sera utilis√© pour construire l'application"
          fi

      # T√©l√©charger l'artefact build du CI
      - name: Download build artifact
        uses: actions/download-artifact@v4
        id: download-artifact
        continue-on-error: true
        with:
          name: react-build-${{ github.event.workflow_run.run_number }}
          path: ./dist

      # Si l'artefact n'existe pas, construire nous-m√™mes
      - name: Build app (fallback if artifact missing)
        if: steps.download-artifact.outcome == 'failure'
        run: |
          echo "‚ö†Ô∏è Artefact manquant, construction en fallback..."
          cd blog
          npm run build
          cp -r dist ../dist/
          echo "‚úÖ Build de fallback termin√©"

      # V√©rifier que le build existe et contient les fichiers attendus
      - name: Verify build
        run: |
          echo "Contenu du r√©pertoire dist:"
          ls -la ./dist/
          echo "V√©rification que index.html existe:"
          test -f ./dist/index.html && echo "‚úÖ index.html trouv√©" || echo "‚ùå index.html manquant"
          echo "V√©rification de la taille du build:"
          du -sh ./dist/
          
      # Test de preview du build
      - name: Test build preview
        run: |
          cd blog
          npm run preview &
          sleep 5
          curl -f http://localhost:4173 || echo "‚ö†Ô∏è Preview test failed"
          pkill -f "vite preview" || true